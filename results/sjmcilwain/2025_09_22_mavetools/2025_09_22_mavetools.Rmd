

library(jsonlite)
library(curl)

getScoreSetJSON<-function(scoreset) {
    url <- paste0("https://api.mavedb.org/api/v1/score-sets/", scoreset)
    message(url)
    response <- curl_fetch_memory(url)
    json_data <- rawToChar(response$content)
    parsed_data <- fromJSON(json_data)
    return(parsed_data)
}

train_data <- read.csv("../../../data/train.csv")

scoresets <- unique(train_data$scoreset)

jsons <- UWCCC.misc::cacheEval(
  fp = "train_mavedb_scoreset_jsons.qs",
  regenerate = FALSE,
  eval_fxn = function() {

jsons <- list()

for (scoreset in scoresets) {
  jsons[[scoreset]] <- getScoreSetJSON(scoreset)
}
return(jsons)
}
)

sequence_df <- data.frame(
  scoreset = names(jsons),
#  uniprot_id = unlist(lapply(jsons, function(l){l$targetGenes$uniprotIdFromMappedMetadata})),
  sequence = unlist(lapply(jsons, function(l){l$targetGenes$targetSequence$sequence})),
  target_gene_name = unlist(lapply(jsons, function(l){l$targetGenes$name}))
)

write.csv(sequence_df, "train_mavedb_scoreset_sequence_df.csv", row.names=FALSE)

